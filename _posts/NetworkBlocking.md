---
title: NetworkBlocking和全局代理
tags:
  - 网络
  - 上网
categories: 网络
date: 2020-04-06 10:59:32
---
<font face="微软雅黑"> </font>
<center>网络阻断的原理和应对方法 </center>

<!-- more -->

# 一些名词

QoS限速：运营商为了优化用户的网络体验，会区分网络应用的优先级，最常见的优先级规则是使用80端口的http包优先级最高。可使用`TLS+Websocket+Nginx+V2ray`应对。

TCP阻断：可以正常的向海外代理服务器发送数据，返回数据时被阻断，客户端就收不到来自服务端的返回数据。Ping IP正常连通(ICMP协议)，而 TCPing IP连接超时无回应(TCP协议)。


# 主要技术
[参考](https://www.wikiwand.com/zh/%E9%98%B2%E7%81%AB%E9%95%BF%E5%9F%8E#/%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E6%9C%8D%E5%8A%A1%E7%BC%93%E5%AD%98%E6%B1%A1%E6%9F%93)
[DNS污染对Clash（for Windows）的影响](https://github.com/Fndroid/clash_for_windows_pkg/wiki/DNS%E6%B1%A1%E6%9F%93%E5%AF%B9Clash%EF%BC%88for-Windows%EF%BC%89%E7%9A%84%E5%BD%B1%E5%93%8D)


1. DNS劫持与污染：刻意制造或无意中制造出来的域名服务器数据包，把域名指往不正确的IP地址。
目前主流的方法主要是 DNS over HTTPS（DoH）和 DNS over TLS（DoT）.

2. IP地址或传输层端口封锁：将需要拦截的IP地址配置为空路由或者黑洞设备上，然后通过动态路由协议将相应配置路由扩散到公众互联网网络中.

3. TCP连接重置：比连接双方更快地发送连接重置消息。TCP重置是TCP的一种消息，用于重置连接。
4. 深度包检测：可對报文内容和协议特征进行检测。

5. 敏感词：HTTP传播的内容是明文的内容。

6. 间歇性完全封锁：所在的公共网络IP地址会被临时封锁，所有的国际网站都无法访问
加密流量探测:提取加密流量数据包，分析其特征。对各种基于TLS加密技术的连接进行刺探。

# 三种代理

代理方式有三种：正向代理、透明代理和反向代理。

**透明代理**
透明代理(transparent proxy)
客户端根本不需要知道有代理服务器的存在，它改变你的request fields（报文），并会传送真实IP，多用于路由器的NAT转发中。
也叫做内网代理(inline proxy)、拦截代理(intercepting proxy)以及强制代理(force proxy)。透明代理和正向代理的行为很相似，但细节上有所不同。透明代理将拦截客户端发送的请求，拦截后自己代为访问服务端，获取响应结果后再由透明代理交给客户端。一般公司内的上网行为管理软件就是透明代理。

**正向代理**
正向代理(forward proxy)，看名字就知道是转发代理。客户端将请求转发给正代服务器，正向代理服务器再负责转发给服务端，响应时服务端先响应给正向代理服务器，正向代理服务器再转发给对应的客户端。也就是说，正向代理可以但不限于为局域网内客户端做代理，它扮演的角色类似于NAT。

**反向代理**
反向代理是为服务端转发请求，客户端将请求发送至反向代理服务器，反向代理服务器再将请求转发给真正的服务器以处理请求，响应时后端真正的服务器将处理结果发送给反向代理，再由反向代理构建响应并响应给客户端。

[V2ray](https://toutyrater.github.io/app/transparent_proxy.html)

# DNS

详细内容见[浅谈在代理环境中的 DNS 解析行为](https://blog.skk.moe/post/what-happend-to-dns-in-proxy/#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99)
[Surge 原理与实现](https://medium.com/@Blankwonder/surge-%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E7%8E%B0-8aa3304fb3bb)
[HTTP 代理原理及实现（一）](https://imququ.com/post/web-proxy.html)

 SOCKS5 代理的浏览器为例:
1. 直连
  浏览器解析DNS
2. 设置代理并使用直连
   DNS 解析是由代理客户端执行，因此在代理客户端上就可以实现一些黑魔法。比如 Surge 自己实现了一个 DNS Server 可以并发向多个上游同时发起查询、比如 V2Ray 可以实现不同域名的查询分流.
3. 设置代理并将流量转发到远端服务器
   某种协议封装域名后发送给远端服务器,远端服务器进行解析.
4. IP或域名分流
   域名分流:浏览器解析列表中的域名；其它发送到远端服务器。
   IP分流：代理客户端解析域名为IP，并比较。直连则复用此IP；其它则发送给远端服务器重新解析域名。
5. redir / tun2socks 实现全局流量经过代理

  全局流量代理可能会出现在路由器上或者 TUN/TAP 型的支持全局代理客户端上。用户不再主动为每个应用程序设置代理。此时应用程序是不会感知到代理客户端的存在，它们会`正常的发起 TCP 连接`，并且由于 TCP/IP 协议，在拿到 DNS 解析结果之前，连接是不能建立的。

  * 浏览器自己都有 DNS 缓存机制，因此浏览器会先开始寻找自己的缓存，不过没有找到 blog.skk.moe 的解析结果
  * 浏览器通过调用操作系统的 getaddrinfo 方法，向操作系统寻求解析结果
  * 操作系统自己也有一层 DNS 缓存，但是现在操作系统从自己的缓存中依然找不到这一结果
  * 在系统的网络设置之中有设置上游 DNS 地址。代理客户端可能会修改系统设置中的 DNS 到 127.0.0.1 或者别的 IP、也可能保留用户之前的设置，这无所谓，因为…
  * 操作系统发出的 DNS 解析请求会经过代理客户端并最终被截获
  * 代理客户端可以将这个解析请求原样发出去、或者用自己的黑魔法，总之代理客户端都会拿到一个解析结果
  * 代理客户端将这个解析结果返回回去，操作系统拿到了这个解析结果并返回给浏览器
  * 浏览器对这个解析结果的 IP 建立一个 TCP 连接并发送出去
  * 这个 TCP 连接被代理客户端截获。由于之前代理客户端进行的 DNS 解析请求这一动作，代理客户端可以找到这个只包含目标 IP 的 TCP 连接原来的目标域名
  * 如果是支持 redir 的代理客户端，那么代理客户端就会直接将域名和 TCP 连接中的其它数据封装成 某种协议 发给远端服务器；或者封装成 SOCKS5 后交给支持 SOCKS5 的代理客户端
  * 如果代理客户端需要按照域名进行分流，一般会在第 6 步代理客户端解析出一个 IP 或者第 9 步代理客户端拿到域名以后。FancySS、KoolSS、SSTap 的流程大抵都是如此。

  和应用程序直接将流量封装成 SOCKS5 大有不同，在类似于透明代理的环境下浏览器和其它应用程序是正常地发起 TCP 连接。因此除非得到一个 DNS 解析结果，否则 TCP 连接不会建立；代理客户端也会需要通过这个 DNS 查询动作，才能找到之后的 TCP 连接的域名。
  你大概能够发现，浏览器、应用程序直接设置 SOCKS5 代理的话，可以不在代理客户端发起 DNS 解析请求就能将流量发送给远端服务器；而在透明代理模式下，不论是否需要 IP 规则分流都需要先进行一次 DNS 解析才能建立连接。

  有没有办法能像直接设置 SOCKS5 代理一样`省掉一次 DNS 解析`呢？
6. 在 redir / tun2socks 中使用 Fake IP
就是代理客户端自己不先执行查询动作，丢一个 Fake IP 回去让浏览器、应用程序立刻建立 TCP 连接：
Fake IP 的定义出自 RFC3089。这个 RFC 定义了一种新的将 TCP 连接封装成 SOCKS 协议的方法。

## FancySS 和 Surge / Clash 的区别
FancySS 是使用的 redir，Surge 的增强模式使用的是 Fake IP，Clash 的增强模式既有 redir-host 也有 Fake IP。首先把 FancySS 等路由器上常见的代理客户端和 Clash 的 redir-host 分为一类，Surge 的增强模式和 Clash 的 fake-ip 模式分为另一类。

路由器上常见的代理客户端一般内置了 dns2socks、dnscryp-proxy、PCap_DNSProxy 等等 DNS 方案、也支持按照一定的规则进行分流，但是都是用于答复应用程序的 DNS question 使其建立 TCP 连接的，除非直连，否则通过这些 DNS 方案拿到的解析结果的 IP 并不会被用上。
大部分路由器上的代理客户端，DNS 解析请求都是通过路由器本机发出（或转发到单一远端服务器进行解析），因此解析结果只能说「至少能用」（不一定是有 CDN 优化的，甚至有可能会有 DNS 污染），如果流量不经过代理客户端直接发往这些 IP 地址，一般也不会影响浏览器、应用程序的正常使用。因此路由器上的代理客户端可以实现通过 iptables 控制让某些端口、某些设备的流量不经过代理客户端。
而在 Fake IP 模式下，浏览器、应用程序都是对 Fake IP 发起连接，如果没有代理客户端对连接进行重新封转，那么这部分流量就不能被发往真实的目的 IP，因此所有流量都必须经过代理客户端，而根据端口、设备的分流就需要由代理客户端自己实现。

## 如果操作系统或者浏览器缓存了 DNS 解析结果

如果是不使用 Fake IP 的 `redir / tun2socks` 情况下，由于操作系统、浏览器或者应用程序中的任何一个缓存了 DNS 解析结果，因此 TCP 连接可以直接根据缓存的解析结果的 IP 建立，代理客户端并没有预先收到对应的 DNS question。在这种情况下，代理客户端有可能直接将这个连接视为和 IP 连接而不是和域名连接，根据`域名规则的分流可能就会因此失效`，不过根据 IP 分流的规则没有失效。
如果为了避免域名分流规则失效，你可以设法阻止操作系统或者浏览器缓存 DNS 解析结果，这样每次建立 TCP 连接之前都会发送 DNS question 使代理客户端探测到域名。但是这意味着每次 TCP 连接建立都需要代理客户端进行一次 DNS 解析请求（当然代理客户端可以对 DNS 解析进行缓存避免出现延时激增）。

而对于 `Fake IP `模式来说，由于代理客户端内存储有 Fake IP 和真实域名之间的映射表，因此即使操作系统或应用程序缓存了 Fake IP，在之后的 TCP 连接中，代理客户端收到流量后依然可以抽取出 Fake IP 反查出域名，因此`不受 DNS 缓存`的影响。

1. 如果使用了 Fake IP，代理客户端不论域名是否真实存在都会返回一个 Fake IP 给浏览器，那么浏览器在试图访问一个不存在的域名时，错误信息应该是什么样的？会不会出现 DNS 解析失败的错误信息？
2. 如果操作系统或者浏览器缓存了 Fake IP，但是代理客户端中 Fake IP 和域名的映射表丢失以后，会出现什么状况？可能会出现什么错误信息？
  这是Clash 在 Fake IP 模式下偶发的无法上网的原因了。

## DNS Fallback
 DNS fallback 的技术（这个名字可能不太对），在代理服务器不支持 UDP 的时候，单纯的全局 TCP/UDP 流量代理 就会出问题了，因为要解析 DNS 就需要 UDP，服务器不支持 UDP 就没办法处理 DNS ，也就没办法处理所有域名请求了，DNS fallback 是一种可以强制让应用程序`把 DNS 请求以 TCP 流量发送出去`的技术。


# Netch

模式介绍
模式 1 进程代理模式 //类似Proxifer
模式 2（需要自己新建模式文件） TUN/TAP IP 黑名单代理模式
模式 3 TUN/TAP （IP 白名单）全局代理模式
模式 4 HTTP 系统代理

使用模式2，设置代理为Clash的本地Socks5地址;无法使用。
netch中显示udpblocked。
nslookup显示NS为本地，但无法解析。
tap网络适配器为连接状态。